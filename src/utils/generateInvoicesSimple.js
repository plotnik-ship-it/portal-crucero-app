import { collection, getDocs, query, where } from 'firebase/firestore';
import { db } from '../services/firebase';
import { generateInvoice } from '../services/invoiceService';

/**
 * Generate invoices for ALL families with payments (no agency filter)
 * Use this when families don't have agencyId field
 * @param {string} targetAgencyId - Agency ID to assign to generated invoices
 */
export const generateInvoicesForAllFamilies = async (targetAgencyId) => {
    try {
        console.log('üîÑ Starting invoice generation for ALL families...');
        console.log('='.repeat(60));

        // Get ALL families
        const familiesRef = collection(db, 'families');
        const familiesSnapshot = await getDocs(familiesRef);

        console.log(`üìã Found ${familiesSnapshot.size} total families\n`);

        let totalInvoicesGenerated = 0;
        let totalPaymentsProcessed = 0;
        let familiesWithPayments = 0;
        const errors = [];

        // Process each family
        for (const familyDoc of familiesSnapshot.docs) {
            const bookingId = familyDoc.id;
            const familyData = familyDoc.data();

            console.log(`\nüë• Processing: ${familyData.displayName || familyData.bookingCode || bookingId}`);

            try {
                // Get all payments for this family
                const paymentsRef = collection(db, 'families', bookingId, 'payments');
                const paymentsSnapshot = await getDocs(paymentsRef);

                if (paymentsSnapshot.empty) {
                    console.log('   ‚è≠Ô∏è No payments found, skipping...');
                    continue;
                }

                familiesWithPayments++;
                console.log(`   üí∞ Found ${paymentsSnapshot.size} payments`);

                // Process each payment directly without checking for existing invoices
                // (to avoid permission issues with querying invoices collection)
                for (const paymentDoc of paymentsSnapshot.docs) {
                    const paymentId = paymentDoc.id;

                    try {
                        // Generate invoice for this payment
                        console.log(`   ‚ú® Generating invoice for payment ${paymentId}...`);
                        await generateInvoice(bookingId, [paymentId], {
                            autoGenerated: false,
                            agencyId: targetAgencyId // Force agency ID
                        });
                        totalInvoicesGenerated++;
                        totalPaymentsProcessed++;
                        console.log(`   ‚úÖ Invoice generated!`);
                    } catch (paymentError) {
                        // If error is "already exists" or similar, that's OK
                        if (paymentError.message && paymentError.message.includes('already')) {
                            console.log(`   ‚è≠Ô∏è Payment ${paymentId} already has invoice`);
                        } else {
                            console.error(`   ‚ùå Error:`, paymentError.message);
                            errors.push({
                                bookingId,
                                bookingCode: familyData.bookingCode || bookingId,
                                paymentId,
                                error: paymentError.message
                            });
                        }
                    }
                }
            } catch (familyError) {
                console.error(`‚ùå Error processing family ${bookingId}:`, familyError);
                errors.push({
                    bookingId,
                    bookingCode: familyData.bookingCode || bookingId,
                    error: familyError.message
                });
            }
        }

        // Summary
        console.log('\n' + '='.repeat(60));
        console.log('üìä INVOICE GENERATION SUMMARY');
        console.log('='.repeat(60));
        console.log(`‚úÖ Invoices generated: ${totalInvoicesGenerated}`);
        console.log(`üí∞ Payments processed: ${totalPaymentsProcessed}`);
        console.log(`üë• Total families: ${familiesSnapshot.size}`);
        console.log(`üíµ Families with payments: ${familiesWithPayments}`);

        if (errors.length > 0) {
            console.log(`\n‚ö†Ô∏è Errors: ${errors.length}`);
            errors.forEach((err, index) => {
                console.log(`\n${index + 1}. Family: ${err.bookingCode}`);
                console.log(`   Payment: ${err.paymentId || 'N/A'}`);
                console.log(`   Error: ${err.error}`);
            });
        }

        console.log('\n' + '='.repeat(60));

        return {
            success: true,
            totalInvoicesGenerated,
            totalPaymentsProcessed,
            totalFamilies: familiesSnapshot.size,
            familiesWithPayments,
            errors
        };
    } catch (error) {
        console.error('‚ùå Fatal error:', error);
        throw error;
    }
};
