rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getUserAgencyId() {
      return getUserData().agencyId;
    }
    
    function isAdmin() {
      return getUserData().role == 'admin';
    }
    
    function isSuperAdmin() {
      return getUserData().isSuperAdmin == true;
    }
    
    function belongsToUserAgency(data) {
      return data.agencyId == getUserAgencyId();
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ============================================
    // Users Collection
    // ============================================
    
    match /users/{userId} {
      // Users can read their own document
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Users can create their own document during signup
      // OR admins can create users
      allow create: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
      
      // Users can update their own document (limited fields)
      // Admins can update any user in their agency
      allow update: if isAuthenticated() && (
        (isOwner(userId)) ||
        (isAdmin() && resource.data.agencyId == getUserAgencyId())
      );
      
      // Only admins can delete users in their agency
      allow delete: if isAuthenticated() && isAdmin() && 
                       resource.data.agencyId == getUserAgencyId();
    }
    
    // ============================================
    // Bookings Collection
    // ============================================
    
    match /bookings/{bookingId} {
      // Read: Must belong to user's agency
      allow read: if isAuthenticated() && belongsToUserAgency(resource.data);
      
      // Create: Must set agencyId to user's agency (admin only)
      allow create: if isAuthenticated() && isAdmin() &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      // Update: Must belong to user's agency, cannot change agencyId
      allow update: if isAuthenticated() && 
                       belongsToUserAgency(resource.data) &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      // Delete: Only admins, must belong to agency
      allow delete: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data);
    }
    
    // ============================================
    // Groups Collection
    // ============================================
    
    match /groups/{groupId} {
      allow read: if isAuthenticated() && belongsToUserAgency(resource.data);
      
      allow create: if isAuthenticated() && isAdmin() &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow update: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data) &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow delete: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data);
      
      // ============================================
      // Imports Subcollection (Immutable Audit Trail)
      // ============================================
      
      match /imports/{importId} {
        // PARAMETERIZED HELPERS - accept groupId to avoid scope issues
        // These receive groupId from the match statement where it's in scope
        
        function parentGroupExists(gid) {
          return exists(/databases/$(database)/documents/groups/$(gid));
        }
        
        function getParentGroupAgencyId(gid) {
          return get(/databases/$(database)/documents/groups/$(gid)).data.agencyId;
        }
        
        // NULL-SAFE: Check exists() BEFORE get() to prevent errors
        function canAccessParentGroup(gid) {
          return parentGroupExists(gid) && (getParentGroupAgencyId(gid) == getUserAgencyId());
        }
        
        // Only admins of the owning agency can read/create
        allow read: if isAuthenticated() && isAdmin() && canAccessParentGroup(groupId);
        allow create: if isAuthenticated() && isAdmin() && canAccessParentGroup(groupId);
        
        // Immutable - no updates or deletes ever
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // Payment Requests Collection
    // ============================================
    
    match /paymentRequests/{requestId} {
      // Families can read their own requests
      // Admins can read all requests in their agency
      allow read: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid) ||
        (isAdmin() && belongsToUserAgency(resource.data))
      );
      
      // Families can create requests for themselves
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      // Only admins can update requests
      allow update: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data) &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      // Only admins can delete requests
      allow delete: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data);
    }
    
    // ============================================
    // Payments Collection
    // ============================================
    
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && belongsToUserAgency(resource.data);
      
      allow create: if isAuthenticated() && isAdmin() &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow update: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data) &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow delete: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data);
    }
    
    // ============================================
    // Agencies Collection
    // ============================================
    
    match /agencies/{agencyId} {
      // Users can read their own agency
      // SuperAdmin can read ALL agencies
      allow read: if isAuthenticated() && (
        agencyId == getUserAgencyId() ||
        isSuperAdmin()
      );
      
      // Authenticated users can create an agency during signup
      // (This is needed for the gated signup flow)
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Admins can update their own agency (cannot change billing)
      // SuperAdmin can update ANY agency (for suspend/reactivate)
      allow update: if isAuthenticated() && (
        // Regular admin updating their own agency
        (isAdmin() && agencyId == getUserAgencyId() &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['billing'])) ||
        // SuperAdmin can update any agency
        isSuperAdmin()
      );
      
      // No one can delete agencies (use Admin SDK)
      allow delete: if false;
      
      // ============================================
      // Team Members Subcollection
      // ============================================
      
      match /members/{memberUid} {
        // Helper: Check if caller is a member of this agency
        // Null-safe: check exists before get
        function isMemberOfAgency() {
          let memberPath = /databases/$(database)/documents/agencies/$(agencyId)/members/$(request.auth.uid);
          return exists(memberPath) && 
                 get(memberPath).data.status == 'active';
        }
        
        // Helper: Check if caller is owner or admin of this agency
        function isAgencyOwnerOrAdmin() {
          let memberPath = /databases/$(database)/documents/agencies/$(agencyId)/members/$(request.auth.uid);
          return exists(memberPath) && 
                 get(memberPath).data.status == 'active' &&
                 get(memberPath).data.role in ['owner', 'admin'];
        }
        
        // Members can read their own membership
        // Owners/admins can read/list all members
        allow read: if isAuthenticated() && (
          request.auth.uid == memberUid ||
          isAgencyOwnerOrAdmin()
        );
        
        // All writes via Cloud Functions Admin SDK only
        allow create, update, delete: if false;
      }
      
      // ============================================
      // Team Invites Subcollection
      // ============================================
      
      match /invites/{inviteId} {
        // Reuse helper from members subcollection context
        function isAgencyOwnerOrAdminForInvites() {
          let memberPath = /databases/$(database)/documents/agencies/$(agencyId)/members/$(request.auth.uid);
          return exists(memberPath) && 
                 get(memberPath).data.status == 'active' &&
                 get(memberPath).data.role in ['owner', 'admin'];
        }
        
        // Only owners/admins can read invites
        allow read: if isAuthenticated() && isAgencyOwnerOrAdminForInvites();
        
        // All writes via Cloud Functions Admin SDK only
        allow create, update, delete: if false;
      }
    }
    
    // ============================================
    // Activity Log Collection
    // ============================================
    
    match /activityLog/{logId} {
      // Only admins can read logs from their agency
      allow read: if isAuthenticated() && isAdmin() &&
                     resource.data.agencyId == getUserAgencyId();
      
      // System creates logs (via Cloud Functions or client)
      allow create: if isAuthenticated() &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      // No updates or deletes (immutable audit trail)
      allow update, delete: if false;
    }
    
    // ============================================
    // Invoices Collection
    // ============================================
    
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && belongsToUserAgency(resource.data);
      
      allow create: if isAuthenticated() && isAdmin() &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow update: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data) &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow delete: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data);
    }
    
    // ============================================
    // Documents Collection
    // ============================================
    
    match /documents/{documentId} {
      allow read: if isAuthenticated() && belongsToUserAgency(resource.data);
      
      allow create: if isAuthenticated() &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow update: if isAuthenticated() &&
                       belongsToUserAgency(resource.data) &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow delete: if isAuthenticated() &&
                       belongsToUserAgency(resource.data);
    }
    
    // ============================================
    // Quotations Collection
    // ============================================
    
    match /quotations/{quotationId} {
      allow read: if isAuthenticated() && belongsToUserAgency(resource.data);
      
      allow create: if isAuthenticated() && isAdmin() &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow update: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data) &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow delete: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data);
    }
    
    // ============================================
    // Reminders Collection
    // ============================================
    
    match /reminders/{reminderId} {
      allow read: if isAuthenticated() && belongsToUserAgency(resource.data);
      
      allow create: if isAuthenticated() && isAdmin() &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow update: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data) &&
                       request.resource.data.agencyId == getUserAgencyId();
      
      allow delete: if isAuthenticated() && isAdmin() &&
                       belongsToUserAgency(resource.data);
    }
    
    // ============================================
    // Agency Requests Collection (Public Write)
    // ============================================
    
    match /agencyRequests/{requestId} {
      // Anyone can create a request (even unauthenticated)
      allow create: if request.resource.data.keys().hasAll([
        'agencyName', 'contactEmail', 'groupType', 'status', 'createdAt'
      ]) && request.resource.data.status == 'pending';
      
      // Only admins can read requests
      allow read: if isAuthenticated() && isAdmin();
      
      // Only admins can update requests (for approval/rejection)
      allow update: if isAuthenticated() && isAdmin();
      
      // No one can delete requests (keep for audit)
      allow delete: if false;
    }
    
    // ============================================
    // Default Deny All
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}